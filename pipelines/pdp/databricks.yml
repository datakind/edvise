bundle:
  name: Edvise pdp training pipeline
  uuid: 99992898-07ae-4641-b086-dd3ba80ffc2f

include:
  - resources/github_pdp_training.yml
  - resources/github_pdp_inference.yml
  - resources/synthetic/github_synth_cleanup.yml

variables:
  git_commit:
    description: "Commit SHA to fetch (dev/CI)"
    default: ""
  git_tag:
    description: "Release tag to fetch for deployment (prod)"
    default: ""
  DB_workspace:
    description: "Databricks workspace"
  datakind_notification_email:
    description: "Datakind address used to send email notifications"
    default: ""
  DK_CC_EMAIL:
    description: "Datakind address used to CC email notifications"
    default: ""
  service_account_executer:
    description: "Service account to execute the pipeline"
  ds_run_as:
    description: "Account to run the pipeline (Databricks SP client/app ID)"
  databricks_institution_name:
    description: "Institution ID to use for the pdp training"
  config_file_name:
    description: "Name of the config file to use for the pdp training"
    default: "config.toml"
  datakind_group_to_manage_workflow:
    description: "Group with permissions to manage the job"
  model_name:
    description: "Name of the model once it's registered and ready to be used for inference"
    default: ""
  training_slack_webhook_id:
    description: "Slack webhook ID for training pipeline failure notifications"
  inference_slack_webhook_id:
    description: "Slack webhook ID for inference pipeline failure notifications"

run_as:
  service_principal_name: ${var.ds_run_as}

targets:
  dev:
    mode: development
    variables:
      DB_workspace: "dev_sst_02"
      training_slack_webhook_id: "1e30ca91-8d95-4324-be05-9d20bffd747b"    # edvise-data-crew channel on dev_sst_02                            
      inference_slack_webhook_id: "1e30ca91-8d95-4324-be05-9d20bffd747b"   # edvise-data-crew channel on dev_sst_02  
    resources:
      jobs:
        github_sourced_pdp_training_pipeline:
          parameters:
            - name: pipeline_version
              default: ${var.git_commit}
          git_source:
            git_url: https://github.com/datakind/edvise
            git_provider: gitHub
            git_commit: ${var.git_commit}
        edvise_github_sourced_pdp_inference_pipeline:
          git_source:
            git_url: https://github.com/datakind/edvise
            git_provider: gitHub
            git_commit: ${var.git_commit}
        edvise_cleanup_synthetic:
          git_source:
            git_url: https://github.com/datakind/edvise
            git_provider: gitHub
            git_commit: ${var.git_commit}
    default: true

  prod:
    mode: production
    variables:
      DB_workspace: "staging_sst_01"
      training_slack_webhook_id: "0fb252f8-f343-4be7-91de-b55f5408a031"  # edvise-data-crew channel on staging_sst_01                                        
      inference_slack_webhook_id: "c51b737e-988d-45dd-ad9b-6f9024a6b56b"  # edvise-support channel on staging_sst_01  
    resources:
      jobs:
        github_sourced_pdp_training_pipeline:
          parameters:
            - name: pipeline_version
              default: ${var.git_tag}
          git_source:
            git_url: https://github.com/datakind/edvise
            git_provider: gitHub
            git_tag: ${var.git_tag}
        edvise_github_sourced_pdp_inference_pipeline:
          git_source:
            git_url: https://github.com/datakind/edvise
            git_provider: gitHub
            git_tag: ${var.git_tag}
        edvise_cleanup_synthetic:
          git_source:
            git_url: https://github.com/datakind/edvise
            git_provider: gitHub
            git_tag: ${var.git_tag}
    workspace:
      root_path: /Workspace/Shared/bundles/${bundle.name}/${bundle.target}
