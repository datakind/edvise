# .github/workflows/test-update-metadata.yml
name: test-update-metadata
on:
  push:
    branches:
      - feature/ci_cd_github_actions

permissions:
  contents: write

jobs:
  update-metadata-dryrun:
    name: Update pyproject + uv.lock + CHANGELOG (no tag)
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: "3.11.11"
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
      # Derive a harmless prerelease (PEP 440-ish / SemVer-friendly)
      # If you pass base_version on dispatch, we'll use "<base>-dev.<run>+<sha7>"
      # Otherwise default to "0.0.0-dev.<run>+<sha7>"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install uv tomlkit git-cliff

      - name: Compute test version (prerelease)
        id: ver
        run: |
          set -euo pipefail
          SHORTSHA=$(git rev-parse --short=7 HEAD)
          BASE="${{ inputs.base_version }}"
          if [ -z "$BASE" ]; then BASE="0.0.0"; fi
          # e.g., 0.2.0-dev.123+abc1234
          VERSION="${BASE}-dev.${GITHUB_RUN_NUMBER}+${SHORTSHA}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Using test version: $VERSION"

      - name: Update pyproject.toml version
        run: |
          python - <<'PY'
          import sys, pathlib, tomlkit
          p = pathlib.Path("pyproject.toml")
          if not p.exists(): sys.exit("pyproject.toml not found")
          doc = tomlkit.parse(p.read_text(encoding="utf-8"))
          version = "${{ steps.ver.outputs.version }}"
          updated = False
          if "project" in doc and "version" in doc["project"]:
              doc["project"]["version"] = version; updated = True
          elif "tool" in doc and "poetry" in doc["tool"] and "version" in doc["tool"]["poetry"]:
              doc["tool"]["poetry"]["version"] = version; updated = True
          if not updated: sys.exit("Need [project].version or [tool.poetry].version")
          p.write_text(tomlkit.dumps(doc), encoding="utf-8")
          print("Set version to", version)
          PY

      - name: Refresh uv lock & sync
        run: |
          uv lock --refresh
          uv venv && uv sync

      - name: Generate CHANGELOG.md (unreleased)
        run: |
          # Use --unreleased so we don't depend on/emit real tags.
          git-cliff --unreleased -o CHANGELOG.md

      - name: Commit changes back to the feature branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name  "datakind-release-bot"
          git config user.email "eng@datakind.org"
          git add pyproject.toml uv.lock CHANGELOG.md || true
          if git diff --cached --quiet; then
            echo "No metadata changes to commit."
            exit 0
          fi
          git commit -m "chore(test-release): bump to ${{ steps.ver.outputs.version }} and refresh metadata [no-tag]"
          git push "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:${{ env.BRANCH_NAME }}

      - name: Upload artifacts (diff visibility)
        uses: actions/upload-artifact@v4
        with:
          name: metadata-preview
          path: |
            pyproject.toml
            uv.lock
            CHANGELOG.md
