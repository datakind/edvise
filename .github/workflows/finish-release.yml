name: Finish Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.1.9)'
        required: true
        type: string
  workflow_run:
    workflows: ["release-branch-ci-dev"]
    types:
      - completed
    branches:
      - release/**
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract version from branch or input
        id: extract-version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            # Strip "v" prefix if provided (e.g., "v0.1.9" -> "0.1.9")
            VERSION="${VERSION#v}"
          else
            # Extract version from release branch name (e.g., release/0.1.9)
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            VERSION=$(echo "$BRANCH" | sed -n 's|release/\([0-9]\+\.[0-9]\+\.[0-9]\+\)|\1|p')
            if [ -z "$VERSION" ]; then
              echo "Error: Could not extract version from branch: $BRANCH"
              exit 1
            fi
          fi
          
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 0.1.9 or v0.1.9), got: $VERSION"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check release branch exists
        run: |
          git fetch origin
          if ! git show-ref --verify --quiet "refs/remotes/origin/release/${{ env.VERSION }}"; then
            echo "Error: Release branch release/${{ env.VERSION }} does not exist"
            exit 1
          fi

      - name: Check integration tests passed
        uses: actions/github-script@v7
        id: check-tests
        with:
          script: |
            const version = process.env.VERSION || context.payload.inputs?.version;
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'release-branch-ci-dev',
              branch: `release/${version}`,
              per_page: 1
            });

            if (runs.workflow_runs.length === 0) {
              core.setFailed('No integration test runs found for this release branch');
              return;
            }

            const latestRun = runs.workflow_runs[0];
            if (latestRun.status !== 'completed' || latestRun.conclusion !== 'success') {
              core.setFailed(`Integration tests have not passed. Status: ${latestRun.status}, Conclusion: ${latestRun.conclusion}`);
              return;
            }

            core.info('✓ Integration tests passed');

      - name: Create Pull Request to main
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "release/${{ env.VERSION }}"
          base: main
          title: "chore: release ${{ env.VERSION }}"
          body: |
            ## Release ${{ env.VERSION }}

            This PR merges the release branch to main.

            - [x] Integration tests passed
            - [x] Version metadata updated
            - [ ] Tag will be created after merge (via workflow)
            - [ ] Main will be merged back to develop after merge (via PR)
            - [ ] Release branch will be deleted after merge

            **After merging this PR:**
            1. A workflow will automatically create tag `v${{ env.VERSION }}`
            2. The tag push will trigger the CD pipeline
            3. A PR will be created to merge main → develop
            4. The release branch will be deleted
          labels: |
            release
          draft: false

  complete-release:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true && startsWith(github.event.pull_request.title, 'chore: release')
    runs-on: ubuntu-latest
    steps:
      - name: Extract version from PR head branch
        id: extract-version
        run: |
          # Extract version from PR head branch name (e.g., release/0.1.9)
          BRANCH="${{ github.event.pull_request.head.ref }}"
          VERSION=$(echo "$BRANCH" | sed -n 's|release/\([0-9]\+\.[0-9]\+\.[0-9]\+\)|\1|p')
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract version from PR head branch: $BRANCH"
            echo "Expected branch format: release/X.Y.Z"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch latest changes
        run: |
          git fetch origin main develop
          git checkout main
          git pull origin main

      - name: Create and push tag
        run: |
          TAG="v${{ env.VERSION }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, skipping creation"
          else
            git tag -a "$TAG" -m "Release ${{ env.VERSION }}"
            git push origin "$TAG"
            echo "✓ Created and pushed tag $TAG"
          fi

      - name: Create PR to merge main into develop
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          base: develop
          title: "chore: sync develop with release ${{ env.VERSION }}"
          body: |
            ## Sync develop with main after release ${{ env.VERSION }}

            This PR merges main into develop to sync the release changes.

            - [x] Release merged to main
            - [x] Tag v${{ env.VERSION }} created
            - [ ] After merge, release branch will be deleted

            **After merging this PR:**
            - The release branch will be automatically deleted
          labels: |
            release
          draft: false

      - name: Delete release branch
        run: |
          RELEASE_BRANCH="release/${{ env.VERSION }}"
          if git show-ref --verify --quiet "refs/remotes/origin/$RELEASE_BRANCH"; then
            git push origin --delete "$RELEASE_BRANCH" || true
            echo "✓ Deleted release branch $RELEASE_BRANCH"
          else
            echo "Release branch $RELEASE_BRANCH does not exist, skipping deletion"
          fi

      - name: Summary
        run: |
          echo "## Release ${{ env.VERSION }} - Part 1 completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ Created and pushed tag v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "✓ Created PR to merge main → develop" >> $GITHUB_STEP_SUMMARY
          echo "✓ Deleted release branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CD pipeline should now be triggered by the tag push.**" >> $GITHUB_STEP_SUMMARY
          echo "**Next step:** Merge the PR to sync develop with main." >> $GITHUB_STEP_SUMMARY

  sync-develop:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true && startsWith(github.event.pull_request.title, 'chore: sync develop')
    runs-on: ubuntu-latest
    steps:
      - name: Extract version from PR title (fallback to main branch tag)
        id: extract-version
        run: |
          # For the main -> develop PR, we need to check the latest tag on main
          # since the PR head branch is "main" (not a release branch)
          # Extract version from PR title as fallback
          TITLE="${{ github.event.pull_request.title }}"
          VERSION=$(echo "$TITLE" | sed -n 's/.*release \([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract version from PR title: $TITLE"
            echo "Expected title format: 'chore: sync develop with release X.Y.Z'"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Summary
        run: |
          echo "## Release ${{ env.VERSION }} completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ Release merged to main" >> $GITHUB_STEP_SUMMARY
          echo "✓ Tag v${{ env.VERSION }} created" >> $GITHUB_STEP_SUMMARY
          echo "✓ Develop synced with main" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CD pipeline should now be triggered by the tag push.**" >> $GITHUB_STEP_SUMMARY

