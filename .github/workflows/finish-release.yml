name: Finish Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.1.9)'
        required: true
        type: string
  workflow_run:
    workflows: ["release-branch-ci-dev"]
    types:
      - completed
    branches:
      - release/**
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  create-finish-pr:
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract version from branch or input
        id: extract-version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from release branch name (e.g., release/0.1.9)
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            VERSION=$(echo "$BRANCH" | sed -n 's|release/\([0-9]\+\.[0-9]\+\.[0-9]\+\)|\1|p')
            if [ -z "$VERSION" ]; then
              echo "Error: Could not extract version from branch: $BRANCH"
              exit 1
            fi
          fi
          
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 0.1.9), got: $VERSION"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check release branch exists
        run: |
          git fetch origin
          if ! git show-ref --verify --quiet "refs/remotes/origin/release/${{ env.VERSION }}"; then
            echo "Error: Release branch release/${{ env.VERSION }} does not exist"
            exit 1
          fi

      - name: Check integration tests passed
        uses: actions/github-script@v7
        id: check-tests
        with:
          script: |
            const version = process.env.VERSION || context.payload.inputs?.version;
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'release-integration.yml', // filename
              branch: `release/${version}`,
              per_page: 1
            });

            if (runs.workflow_runs.length === 0) {
              core.setFailed('No integration test runs found for this release branch');
              return;
            }

            const latestRun = runs.workflow_runs[0];
            if (latestRun.status !== 'completed' || latestRun.conclusion !== 'success') {
              core.setFailed(`Integration tests have not passed. Status: ${latestRun.status}, Conclusion: ${latestRun.conclusion}`);
              return;
            }

            core.info('✓ Integration tests passed');

      - name: Fetch latest changes
        run: |
          git fetch origin main develop
          git checkout main
          git pull origin main

      - name: Merge release branch to main
        run: |
          RELEASE_BRANCH="release/${{ env.VERSION }}"
          git fetch origin "$RELEASE_BRANCH"
          git checkout -b "finish-release-${{ env.VERSION }}"
          git merge "origin/$RELEASE_BRANCH" --no-ff -m "chore: release ${{ env.VERSION }}"
          git push -u origin "finish-release-${{ env.VERSION }}"

      - name: Create Pull Request to main
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "finish-release-${{ env.VERSION }}"
          base: main
          title: "chore: finish release ${{ env.VERSION }}"
          body: |
            ## Finish Release ${{ env.VERSION }}

            This PR merges the release branch to main and completes the release process.

            - [x] Integration tests passed
            - [x] Release branch merged to main
            - [ ] Tag will be created after merge (via workflow)
            - [ ] Main will be merged back to develop after merge
            - [ ] Release branch will be deleted after merge

            **After merging this PR:**
            1. A workflow will automatically create tag `v${{ env.VERSION }}`
            2. The tag push will trigger the CD pipeline
            3. Main will be merged back to develop
            4. The release branch will be deleted
          labels: |
            release
          draft: false

  complete-release:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true && startsWith(github.event.pull_request.title, 'chore: finish release')
    runs-on: ubuntu-latest
    steps:
      - name: Extract version from PR title
        id: extract-version
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          VERSION=$(echo "$TITLE" | sed -n 's/.*finish release \([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract version from PR title: $TITLE"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch latest changes
        run: |
          git fetch origin main develop
          git checkout main
          git pull origin main

      - name: Create and push tag
        run: |
          TAG="v${{ env.VERSION }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists, skipping creation"
          else
            git tag -a "$TAG" -m "Release ${{ env.VERSION }}"
            git push origin "$TAG"
            echo "✓ Created and pushed tag $TAG"
          fi

      - name: Merge main to develop
        run: |
          git checkout develop
          git pull origin develop
          git merge origin/main --no-ff -m "chore: merge main into develop after release ${{ env.VERSION }}"
          git push origin develop
          echo "✓ Merged main to develop"

      - name: Delete release branch
        run: |
          RELEASE_BRANCH="release/${{ env.VERSION }}"
          if git show-ref --verify --quiet "refs/remotes/origin/$RELEASE_BRANCH"; then
            git push origin --delete "$RELEASE_BRANCH" || true
            echo "✓ Deleted release branch $RELEASE_BRANCH"
          else
            echo "Release branch $RELEASE_BRANCH does not exist, skipping deletion"
          fi

      - name: Clean up finish-release branch
        run: |
          FINISH_BRANCH="finish-release-${{ env.VERSION }}"
          if git show-ref --verify --quiet "refs/remotes/origin/$FINISH_BRANCH"; then
            git push origin --delete "$FINISH_BRANCH" || true
            echo "✓ Deleted finish-release branch $FINISH_BRANCH"
          fi

      - name: Summary
        run: |
          echo "## Release ${{ env.VERSION }} completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✓ Created and pushed tag v${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "✓ Merged main to develop" >> $GITHUB_STEP_SUMMARY
          echo "✓ Deleted release branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CD pipeline should now be triggered by the tag push.**" >> $GITHUB_STEP_SUMMARY

